# 代祷告功能设计说明书

## 一、功能概述

### 1.1 背景
基于实时的消息流推送机制，以祷告为群系，为用户提供具有初步社交雏形的特性。

产品Prd: [点我](https://zin8ujy4xk2.feishu.cn/docx/SxW8dkqjjoh1gExrghGc0JgAnLd?from=from_copylink)

## 二、功能需求

### 2.1 用户需求
1. 我希望我发出去的消息能够**立刻**被**更多人**看到，并且结识到愿意为我的信仰共同祷告的朋友。
2. 我希望我能够收到来自于别人的祷告请求，并且帮别人完成祷告，在我的日常行为中认识到新的朋友。

### 2.2 系统需求
1. 用户发出去的消息不会丢失，并且立刻送达给另一个用户。
2. 用户无论实时或者离线都能够收到传达给"我"的消息
    + 处于前台时，界面需要实时刷新"我"收到的消息
    + 处于后台时，界面需要在重新加载时刷新"我"收到的消息
3. 尽量减少前后端推送的消息体大小，节省带宽以及服务端压力

## 三、功能描述

### 3.1 功能模块

1. **代祷告会话服务**，主要负责以下职责
    + 会话管理：创建、更新和删除代祷告会话。
    + 消息收发：管理消息的发送和接收，包括存储消息内容和时间戳。
    + 实时推送：实时推送新消息给会话中的参与者，确保消息的及时送达。
    + 消息分发：根据一定的规则分发消息给机器人或真人用户。
    + 会话历史：存储和查询会话历史记录，支持用户查看历史消息。
    + 用户权限：验证用户对会话的访问权限，确保只有会话的参与者可以访问会话内容。
2. **机器人服务**，主要负责以下职责
    + 供代祷告会话服务从机器人池子里面挑选机器人作为对话的对象。
3. **用户信息服务**，主要负责以下职责
    + 获取用户的用户名以及头像。

### 3.2 功能流程
#### 3.2.1 创建会话流程

<code-block lang="mermaid">
graph TD
    A[用户请求创建新会话] --> B[代祷告会话服务]
    B --> C[验证用户权限]
    C -->|验证通过| D[检查用户当天发送次数]
    D --> E{发送次数小于3?}
    E -->|是| F[2/3概率分配机器人]
    E -->|否| G[30%概率分配机器人]
    F --> H[从机器人池中挑选机器人]
    G --> H[从机器人池中挑选机器人]
    F --> I[分配真人用户]
    G --> I[分配真人用户]
    H --> J[创建新会话]
    I --> J[创建新会话]
    C -->|验证失败| O[返回权限错误]

    style A fill:#f9f,stroke:#333,stroke-width:2px
    style O fill:#f99,stroke:#333,stroke-width:2px
</code-block>

#### 3.2.2 消息收发流程
<code-block lang="mermaid">
graph TD
    A[用户A发送新消息请求] --> B[代祷告会话服务]
    B --> C[验证用户A的权限]
    C -->|验证通过| D[加载会话信息]
    D --> E[存储新消息内容和时间戳]
    E --> F[更新会话的更新时间]
    F --> G[保存更新后的会话信息]
    G --> H[实时推送新消息给用户B]
    H --> I[用户B接收到新消息通知]
    C -->|验证失败| J[返回权限错误]

    style A fill:#f9f,stroke:#333,stroke-width:2px
    style I fill:#bbf,stroke:#333,stroke-width:2px
    style J fill:#f99,stroke:#333,stroke-width:2px
</code-block>

## 四、技术实现

### 4.1 架构设计
代祷告功能的系统架构设计如下：

**后端**：
- 使用ASP.NET Core构建Web API服务。
- 使用AWS AppSync实现消息的实时推送。
- 使用Amazon DynamoDB存储会话和消息数据。
<note>

#### AWS AppSync 基础知识
AWS AppSync 是一种完全托管的服务，使您能够轻松地使用 GraphQL 构建可扩展的应用程序。以下是一些关键概念：

- **GraphQL**：一种用于 API 的查询语言，允许客户端请求所需的数据，并且只返回所请求的数据。
- **Schema**：定义了 API 的数据类型和操作（查询、变更和订阅）。
- **Resolvers**：将 GraphQL 操作映射到数据源（如 DynamoDB、Lambda、HTTP 等）。
- **Subscriptions**：允许客户端订阅特定事件（如新消息），当事件发生时，服务器会推送更新给客户端。

在代祷告功能中，AWS AppSync 将用于实现消息的实时推送。具体步骤如下：

1. **定义 GraphQL Schema**：定义代祷告会话和消息的类型，以及相关的查询、变更和订阅操作。
2. **配置 Resolvers**：将 GraphQL 操作映射到 DynamoDB 数据源，以便存储和检索会话和消息数据。
3. **实现 Subscriptions**：定义订阅操作，当新消息发送时，AppSync 会推送更新给订阅的客户端。
</note>


### 4.2 数据库设计
代祷告功能涉及的主要数据库表结构如下：

1. **PraySessionModel**：
    - `Id` (string): 会话ID
    - `RK` (string): 会话范围键（由发送者和接收者ID组成）
    - `CreatedAt` (DateTime): 会话创建时间
    - `UpdatedAt` (DateTime): 会话更新时间
    - `Messages` (List&lt;PrayMessage&gt;): 会话中的消息列表

2. **PrayMessage**：
    - `SenderId` (string): 发送者ID
    - `Content` (string): 消息内容
    - `Timestamp` (DateTime): 消息时间戳

### 4.3 接口设计
代祷告功能涉及的主要接口设计如下：
